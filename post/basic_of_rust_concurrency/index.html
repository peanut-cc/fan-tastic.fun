<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>ã€ŠRust Atomics and Locks Low-Level ã€‹é˜…è¯»ç¬”è®°1 - fan-tastic.fun</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="fan-tastic.fun"><meta name=description content="Threads in Rust åœ¨ Rust ä¸­ å¯ä»¥é€šè¿‡æ ‡å‡†åº“ä¸­ std:ğŸ§µ:spawn åˆ›å»ºçº¿ç¨‹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 use std::thread; fn main() { thread::spawn(f); thread::spawn(f); println!(&amp;#34;Hello from the main thread.&amp;#34;); } fn f() { println!(&amp;#34;hello from another thread&amp;#34;); let id = thread::current().id(); println!(&amp;#34;This is"><meta name=keywords content="rust,thread,concurrency"><meta name=generator content="Hugo 0.104.0 with theme even"><link rel=canonical href=https://www.fan-tastic.fun/post/basic_of_rust_concurrency/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="ã€ŠRust Atomics and Locks Low-Level ã€‹é˜…è¯»ç¬”è®°1"><meta property="og:description" content="Threads in Rust åœ¨ Rust ä¸­ å¯ä»¥é€šè¿‡æ ‡å‡†åº“ä¸­ std:ğŸ§µ:spawn åˆ›å»ºçº¿ç¨‹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 use std::thread; fn main() { thread::spawn(f); thread::spawn(f); println!(&#34;Hello from the main thread.&#34;); } fn f() { println!(&#34;hello from another thread&#34;); let id = thread::current().id(); println!(&#34;This is"><meta property="og:type" content="article"><meta property="og:url" content="https://www.fan-tastic.fun/post/basic_of_rust_concurrency/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-04-18T14:38:08+08:00"><meta property="article:modified_time" content="2023-04-23T11:10:04+08:00"><meta itemprop=name content="ã€ŠRust Atomics and Locks Low-Level ã€‹é˜…è¯»ç¬”è®°1"><meta itemprop=description content="Threads in Rust åœ¨ Rust ä¸­ å¯ä»¥é€šè¿‡æ ‡å‡†åº“ä¸­ std:ğŸ§µ:spawn åˆ›å»ºçº¿ç¨‹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 use std::thread; fn main() { thread::spawn(f); thread::spawn(f); println!(&#34;Hello from the main thread.&#34;); } fn f() { println!(&#34;hello from another thread&#34;); let id = thread::current().id(); println!(&#34;This is"><meta itemprop=datePublished content="2023-04-18T14:38:08+08:00"><meta itemprop=dateModified content="2023-04-23T11:10:04+08:00"><meta itemprop=wordCount content="3000"><meta itemprop=keywords content="Rust,"><meta name=twitter:card content="summary"><meta name=twitter:title content="ã€ŠRust Atomics and Locks Low-Level ã€‹é˜…è¯»ç¬”è®°1"><meta name=twitter:description content="Threads in Rust åœ¨ Rust ä¸­ å¯ä»¥é€šè¿‡æ ‡å‡†åº“ä¸­ std:ğŸ§µ:spawn åˆ›å»ºçº¿ç¨‹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 use std::thread; fn main() { thread::spawn(f); thread::spawn(f); println!(&#34;Hello from the main thread.&#34;); } fn f() { println!(&#34;hello from another thread&#34;); let id = thread::current().id(); println!(&#34;This is"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>fan-tastic</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>fan-tastic</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>ã€ŠRust Atomics and Locks Low-Level ã€‹é˜…è¯»ç¬”è®°1</h1><div class=post-meta><span class=post-time>2023-04-18</span><div class=post-category><a href=/categories/rust/>Rust</a></div><span class=more-meta>3000 words</span>
<span class=more-meta>6 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#threads-in-rust>Threads in Rust</a></li><li><a href=#å…±äº«æ‰€æœ‰æƒ-å’Œ-å¼•ç”¨è®¡æ•°>å…±äº«æ‰€æœ‰æƒ å’Œ å¼•ç”¨è®¡æ•°</a></li><li><a href=#å†…éƒ¨å¯å˜æ€§-interior-mutability>å†…éƒ¨å¯å˜æ€§ Interior Mutability</a></li><li><a href=#rwlock-and-mutex>RwLock and Mutex</a></li><li><a href=#condition-variables>Condition Variables</a></li><li><a href=#thread-safety>Thread Safety</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=threads-in-rust>Threads in Rust</h2><p>åœ¨ Rust ä¸­ å¯ä»¥é€šè¿‡æ ‡å‡†åº“ä¸­ <code>std:ğŸ§µ:spawn</code> åˆ›å»ºçº¿ç¨‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello from the main thread.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>f</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;hello from another thread&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread</span>::<span class=n>current</span><span class=p>().</span><span class=n>id</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;This is my thread id:{id:?}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™æ®µä»£ç éœ€è¦æ³¨æ„,<code>main</code> çº¿ç¨‹ä¸€æ—¦ç»“æŸï¼Œç¨‹åºå°±ä¼šç«‹åˆ»é€€å‡ºï¼Œä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡<code>thread::spawn(f);</code>åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å¤šæ¬¡è¿è¡Œç¨‹åºä½ ä¼šå‘ç°ï¼Œä»–ä»¬å¯èƒ½å¹¶æ²¡æœ‰æœºä¼šè¿è¡Œã€‚</p><p>å¦‚æœæƒ³è¦ä¿è¯æ‰€æœ‰çš„çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œå¯ä»¥ä½¿ç”¨ <code>join</code> æ–¹æ³•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>t2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello from the main thread.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t1</span><span class=p>.</span><span class=n>join</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>t2</span><span class=p>.</span><span class=n>join</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>f</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;hello from another thread&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread</span>::<span class=n>current</span><span class=p>().</span><span class=n>id</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;This is my thread id:{id:?}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>join</code> æ–¹æ³•ä¼šç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆå¹¶åˆ‡è¿”å› <code>std:ğŸ§µ:Result</code>,å¦‚æœçº¿ç¨‹æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¸ªè¿”å›çš„æ•°æ®ä¸­å°†ä¼šåŒ…å«<code>panic</code>çš„ä¿¡æ¯ã€‚</p><p>åœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™è¿˜æœ‰ä¸€ç§ä½¿ç”¨æ›´å¤šçš„æ–¹å¼æ˜¯é€šè¿‡é—­åŒ…ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>&amp;</span><span class=n>numbers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{n}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>join</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å› ä¸ºåœ¨é—­åŒ…çš„æ—¶å€™ä½¿ç”¨çš„<code>move</code>, <code>numbers</code>çš„æ‰€æœ‰æƒä¼šä¼ å…¥åˆ°æ–°çš„å¼€å¯çš„çº¿ç¨‹ä¸­ã€‚
å¦‚æœæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨<code>move</code>, å°±ä¸æ˜¯å‘ç”Ÿæ‰€æœ‰æƒçš„è½¬ç§»ï¼Œè€Œæ˜¯é€šè¿‡å¼•ç”¨çš„æ–¹å¼åœ¨æ–°çš„çº¿ç¨‹ä¸­ä½¿ç”¨<code>numbers</code>ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ç¼–è¯‘ä»£ç å°±ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>5</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>                   </span><span class=o>^^</span><span class=w> </span><span class=n>may</span><span class=w> </span><span class=n>outlive</span><span class=w> </span><span class=n>borrowed</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=err>`</span><span class=n>numbers</span><span class=err>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=k>for</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>&amp;</span><span class=n>numbers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>                   </span><span class=o>-------</span><span class=w> </span><span class=err>`</span><span class=n>numbers</span><span class=err>`</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>borrowed</span><span class=w> </span><span class=n>here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>note</span>: <span class=nc>function</span><span class=w> </span><span class=n>requires</span><span class=w> </span><span class=n>argument</span><span class=w> </span><span class=k>type</span> <span class=nc>to</span><span class=w> </span><span class=n>outlive</span><span class=w> </span><span class=err>`</span><span class=o>&#39;</span><span class=nb>static</span><span class=err>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>-</span>-&gt; <span class=nc>ch1</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=n>spawn</span><span class=o>-</span><span class=n>closure</span><span class=p>.</span><span class=n>rs</span>:<span class=mi>5</span>:<span class=mi>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>5</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>/</span><span class=w>     </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=k>for</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>&amp;</span><span class=n>numbers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>7</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>             </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{n}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>8</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>9</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=n>______</span><span class=o>^</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>help</span>: <span class=nc>to</span><span class=w> </span><span class=n>force</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>closure</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>take</span><span class=w> </span><span class=n>ownership</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=err>`</span><span class=n>numbers</span><span class=err>`</span><span class=w> </span><span class=p>(</span><span class=n>and</span><span class=w> </span><span class=n>any</span><span class=w> </span><span class=n>other</span><span class=w> </span><span class=n>referenced</span><span class=w> </span><span class=n>variables</span><span class=p>),</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=err>`</span><span class=k>move</span><span class=err>`</span><span class=w> </span><span class=n>keyword</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>5</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>                   </span><span class=o>++++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>error</span>: <span class=nc>aborting</span><span class=w> </span><span class=n>due</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>previous</span><span class=w> </span><span class=n>error</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><code>spawn</code>å‡½æ•°å¯¹å…¶å‚æ•°ç±»å‹æœ‰ä¸€ä¸ª &ldquo;é™æ€å¯¿å‘½&rdquo; çš„çº¦æŸï¼Œä¸€ä¸ªé€šè¿‡å¼•ç”¨æ•è·å±€éƒ¨å˜é‡çš„é—­åŒ…ä¸å¯èƒ½ä¸€ç›´å­˜åœ¨ï¼Œå½“å±€éƒ¨å˜é‡ä¸å†å­˜åœ¨æ—¶ï¼Œå°±ä¼šå¯¼è‡´å¼•ç”¨æ— æ•ˆã€‚</p><p>Rust æ ‡å‡†åº“ <code>std:ğŸ§µ:scope</code>å¯ä»¥åˆ›å»º <code>scoped threads</code>, å…è®¸åˆ›å»ºçš„çº¿ç¨‹å®‰å…¨çš„å€Ÿç”¨å±€éƒ¨å˜é‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>numbers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>scope</span><span class=p>(</span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>numbers</span><span class=p>.</span><span class=n>len</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>&amp;</span><span class=n>numbers</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;{n}&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨<code>scope</code> ä¸ç”¨åœ¨ä½¿ç”¨ <code>join</code> æ–¹æ³•ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œè€Œæ˜¯å˜æˆè‡ªåŠ¨ <code>join</code></p><h2 id=å…±äº«æ‰€æœ‰æƒ-å’Œ-å¼•ç”¨è®¡æ•°>å…±äº«æ‰€æœ‰æƒ å’Œ å¼•ç”¨è®¡æ•°</h2><p>åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«æ•°æ®æ—¶ï¼Œæ— æ³•ä¿è¯ä¸€ä¸ªçº¿ç¨‹æ¯”å¦å¤–ä¸€ä¸ªçº¿ç¨‹â€œæ´»å¾—æ›´ä¹…â€ï¼Œå®ƒä»¬éƒ½ä¸èƒ½æˆä¸ºè¯¥æ•°æ®çš„æ‰€æœ‰è€…ã€‚</p><p><code>static</code> é™æ€å˜é‡ä¼šåœ¨æ•´ä¸ªç¨‹åºè¿è¡Œçš„æ—¶æœŸä¸­å­˜åœ¨ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥å€Ÿç”¨å®ƒã€‚
<code>Box</code> ä½¿ç”¨<code>Box::leak</code>ï¼Œå¯ä»¥é‡Šæ”¾ä¸€ä¸ª<code>Box</code>çš„æ‰€æœ‰æƒï¼Œå¹¶ä¿è¯æ°¸è¿œä¸æ”¾å¼ƒå®ƒã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>x</span>: <span class=kp>&amp;</span><span class=o>&#39;</span><span class=nb>static</span> <span class=p>[</span><span class=kt>i32</span><span class=p>;</span><span class=w> </span><span class=mi>3</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Box</span>::<span class=n>leak</span><span class=p>(</span><span class=nb>Box</span>::<span class=n>new</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>]));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>x</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>x</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Rust æ ‡å‡†åº“ <code>std::rc::Rc</code> , å¼•ç”¨è®¡æ•°ï¼Œclone å®ƒå¹¶ä¸ä¼šåˆ†é…ä»»ä½•æ–°çš„ä¸œè¥¿ï¼Œè€Œæ˜¯å¢åŠ ä¸€ä¸ªå­˜å‚¨çš„å€¼çš„ä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚éœ€è¦æ³¨æ„ï¼š<code>Rc</code> ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>rc</span>::<span class=n>Rc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Rc</span>::<span class=n>new</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=n>as_ptr</span><span class=p>(),</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>as_ptr</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä»£ç ä¸­ å˜é‡a å’Œ å˜é‡b å…±äº«æ‰€æœ‰æƒã€‚</p><p>æ ‡å‡†åº“<code>std::sync::Arc</code>ï¼Œæ ‡è¯†åŸå­å¼•ç”¨è®¡æ•°ï¼Œä¿è¯äº†å¯¹å¼•ç”¨çš„è®¡æ•°å™¨çš„ä¿®æ”¹æ˜¯<code>åŸå­æ“ä½œ</code>,å› æ­¤å¯ä»¥å®‰å…¨çš„ç”¨äºå¤šçº¿ç¨‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Arc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arc</span>::<span class=n>new</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>a</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>b</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>Rust allows (and encourages) you to shadow variables by defining a new variable with the same name</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Arc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arc</span>::<span class=n>new</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>spawn</span><span class=p>({</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>a</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>Because ownership is shared, reference counting pointers (<code>Rc&lt;T></code> and <code>Arc&lt;T></code>) have the same restrictions as shared references (<code>&T</code>). They do not give you mutable access to their contained value, since the value might be borrowed by other code at the same time.</p></blockquote><h2 id=å†…éƒ¨å¯å˜æ€§-interior-mutability>å†…éƒ¨å¯å˜æ€§ Interior Mutability</h2><p>å…±äº«å¼•ç”¨ï¼ˆ<code>&T</code>ï¼‰å¯ä»¥è¢«å¤åˆ¶å¹¶ä¸ä»–äººå…±äº«ï¼Œè€Œç‹¬å å¼•ç”¨ï¼ˆ<code>&mut T</code>ï¼‰åˆ™ä¿è¯å®ƒæ˜¯è¯¥<code>T</code>çš„å”¯ä¸€ç‹¬å å€Ÿç”¨ã€‚</p><p>ä½¿ç”¨æ ‡å‡†åº“ <code>std::cell:Cell&lt;T></code> å…è®¸é€šè¿‡å…±äº«å¼•ç”¨è¿›è¡Œçªå˜ï¼Œå…è®¸æŠŠå€¼å¤åˆ¶å‡ºæ¥ï¼ˆå¦‚æœTæ˜¯å¯Copyçš„ï¼‰ï¼Œæˆ–è€…ç”¨å¦å¤–ä¸€ä¸ªå€¼æ›¿æ¢ã€‚
æ³¨æ„ï¼šCell åªèƒ½åœ¨å•ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>f</span><span class=p>(</span><span class=n>v</span>: <span class=kp>&amp;</span><span class=nc>Cell</span><span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>i32</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>v2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>take</span><span class=p>();</span><span class=w> </span><span class=c1>// Replaces the contents of the Cell with an empty Vec
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>v2</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>v</span><span class=p>.</span><span class=n>set</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span><span class=w> </span><span class=c1>// Put the modified Vec back
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>a <code>std::cell::RefCell</code> does allow you to borrow its contents, at a small runtime cost.</p><p>ä¸€ä¸ª<code>RefCell&lt;T></code>ä¸ä»…æŒæœ‰ä¸€ä¸ª<code>T</code>ï¼Œè€Œä¸”è¿˜æŒæœ‰ä¸€ä¸ª<code>counter</code>ï¼Œç”¨äºè·Ÿè¸ªä»»ä½•æœªå®Œæˆçš„<code>borrow</code>ã€‚å¦‚æœå·²ç»è¢«<code>mutably borrow</code>äº†ï¼Œå†è¿›è¡Œå€Ÿç”¨ï¼Œå°±ä¼šPanicã€‚
æ³¨æ„ï¼šRefCell åªèƒ½åœ¨å•ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>cell</span>::<span class=n>RefCell</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>f</span><span class=p>(</span><span class=n>v</span>: <span class=kp>&amp;</span><span class=nc>RefCell</span><span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>i32</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>v</span><span class=p>.</span><span class=n>borrow_mut</span><span class=p>().</span><span class=n>push</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w> </span><span class=c1>// We can modify the `Vec` directly.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=rwlock-and-mutex>RwLock and Mutex</h2><p><code>RwLock</code> æ˜¯<code>RefCell</code>çš„å¹¶å‘ç‰ˆæœ¬ï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªä¸ä¼šåœ¨å†²çªçš„<code>borrow</code> å‘ç”Ÿpanic, è€Œæ˜¯é˜»å¡å½“å‰çš„çº¿ç¨‹ï¼Œä½¿å…¶è¿›å…¥ç¡çœ çŠ¶æ€ï¼ŒåŒæ—¶ç­‰å¾…å†²çªçš„<code>borrow</code> æ¶ˆå¤±ã€‚</p><p><code>Mutex</code> ä¸ä¼šåƒ RwLocké‚£æ ·è®°å½•å…±äº«å’Œç‹¬å çš„å€Ÿç”¨çš„æ•°é‡ï¼Œè€Œåªå…è®¸ç‹¬å <code>borrow</code>ã€‚</p><p><code>atomic</code>æ˜¯ <code>Cell</code>çš„å¹¶å‘ç‰ˆæœ¬ï¼Œä¸è¿‡ä¸åŒçš„æ˜¯ä¸èƒ½æœ‰ä»»æ„çš„å¤§å°ï¼Œæ‰€ä»¥æ²¡æœ‰é€šç”¨çš„<code>Atomic&lt;T></code>ç±»å‹ï¼Œåªæœ‰ç‰¹å®šç±»å‹çš„<code>Atomic</code>ç±»å‹ã€‚</p><p>ä¸ºäº†ä¿è¯è¢«Lockçš„çš„<code>Mutex</code>åªèƒ½è¢«<code>Lock</code> çš„çº¿ç¨‹è§£é”ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª<code>unlock()</code>æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨<code>lock()</code>æ–¹æ³•è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ç±»å‹<code>MutexGuard</code>, è¿™ä¸ªå°±æ ‡è¯†äº†æˆ‘ä»¬å·²ç»é”å®šäº†<code>Mutex</code>, å®ƒçš„è¡Œä¸ºç±»ä¼¼äºé€šè¿‡<code>DerefMut</code>ç‰¹æ€§çš„ç‹¬å å¼•ç”¨ï¼Œè®©æˆ‘ä»¬ç‹¬å è®¿é—®<code>Mutex</code>æ‰€ä¿æŠ¤çš„æ•°æ®ã€‚è§£é™¤å¯¹<code>Mutex</code>çš„é”å®šæ˜¯é€šè¿‡ Drop guardã€‚</p><p>When we drop the guard, we give up our ability to access the data, and the Drop implementation of the guard will unlock the mutex.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Mutex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>scope</span><span class=p>(</span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>10</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>s</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>guard</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=mi>100</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>*</span><span class=n>guard</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>n</span><span class=p>.</span><span class=n>into_inner</span><span class=p>().</span><span class=n>unwrap</span><span class=p>(),</span><span class=w> </span><span class=mi>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>After the threads are done, we can safely remove the protection from the integer through into_inner(). The into_inner method takes ownership of the mutex, which guarantees that nothing else can have a reference to the mutex anymore, making locking unnecessary.</p><p>åœ¨Rust ä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”çš„æ—¶å€™å‡ºç°çš„panic, <code>Mutext</code>ä¼šè¢«æ ‡è®°ä¸º <code>poisoned</code>, è¿™ç§æƒ…å†µä¸‹<code>Mutex</code>å°†ä¸å†è¢«é”å®šï¼Œä½†è°ƒç”¨å®ƒçš„é”å®šæ–¹æ³•å°†ä¼šå¯¼è‡´ä¸€ä¸ªErræ¥æ ‡è¯†å·²ç»è¢« <code>poisoned</code>ã€‚
åœ¨ä¸€ä¸ªå·²ç»è¢«æ ‡è®°ä¸º<code>poisoned</code>çš„<code>Mutext</code>è°ƒç”¨<code>lock()</code>ä»ç„¶ä¼šé”å®šè¯¥<code>Mutext</code>, <code>lock()</code> çš„ Err åŒ…å« <code>MutextGuard</code>,å…è®¸æˆ‘ä»¬åœ¨å¿…è¦æ—¶çº æ­£ä¸€ä¸ªä¸ä¸€è‡´çš„çŠ¶æ€ã€‚</p><p><code>RwLock</code> æœ‰ä¸‰ç§çŠ¶æ€ï¼š è§£é”ï¼Œè¢«å•ä¸ªå†™é”å®šï¼ˆç”¨äºç‹¬å è®¿é—®ï¼‰ï¼Œè¢«ä»»ä½•æ•°é‡çš„è¯»é”å®šï¼ˆç”¨äºå…±äº«è®¿é—®ï¼‰ï¼Œé€šç•…ç”¨äºç»å¸¸è¢«å¤šä¸ªçº¿ç¨‹è¯»å–çš„æ•°æ®ã€‚
æä¾›äº†<code>read()</code>å’Œ<code>write()</code>æ–¹æ³•,ç”¨äºè¯»é”æˆ–è€…å†™é”ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæœ‰ä¸¤ä¸ª<code>guard</code>ç±»å‹ <code>RwLockReadGuard</code>å’Œ <code>RwLockWriteGuard</code>ã€‚
<code>Mutext&lt;T></code> å’Œ <code>RwLock&lt;T></code>éƒ½è¦æ±‚<code>T</code>å®ç° <code>Send</code>,å› ä¸ºä»–ä»¬å¯ä»¥ç”¨æ¥å‘é€ä¸€ä¸ª<code>T</code>ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ <code>RwLock&lt;T></code> è¿˜è¦æ±‚Tå®ç°<code>Sync</code> å®ƒå…è®¸å¤šä¸ªçº¿ç¨‹å¯¹å—ä¿æŠ¤æ•°æ®çš„å…±äº«å¼•ç”¨ï¼ˆ<code>&T</code>ï¼‰</p><p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ <code>park</code>è‡ªå·±ï¼Œè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œåœæ­¢æ¶ˆè€—ä»»ä½•CPU, å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯ä»¥<code>unpark</code> è¢« <code>park</code>çŠ¶æ€çš„çº¿ç¨‹ï¼ŒæŠŠå®ƒä»ç¡çœ çŠ¶æ€å”¤é†’ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>collections</span>::<span class=n>VecDeque</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Mutex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>time</span>::<span class=n>Duration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=n>VecDeque</span>::<span class=n>new</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>scope</span><span class=p>(</span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>().</span><span class=n>pop_front</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span>::<span class=n>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>().</span><span class=n>push_back</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>t</span><span class=p>.</span><span class=n>thread</span><span class=p>().</span><span class=n>unpark</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>thread</span>::<span class=n>sleep</span><span class=p>(</span><span class=n>Duration</span>::<span class=n>from_secs</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=condition-variables>Condition Variables</h2><p>Condition variables are a more commonly used option for waiting for something to happen to data protected by a mutex. They have two basic operations: wait and notify.
Threads can wait on a condition variable, after which they can be woken up when another thread notifies that same condition variable. Multiple threads can wait on the same condition variable, and notifications can either be sent to one waiting thread, or to all of them.
This means that we can create a condition variable for specific events or conditions weâ€™re interested in, such as the queue being non-empty, and wait on that condition.
Any thread that causes that event or condition to happen then notifies the condition variable, without having to know which or how many threads are interested in that notification.
The Rust standard library provides a condition variable as std::sync::Condvar. Its wait method takes a MutexGuard that proves weâ€™ve locked the mutex. It first unlocks the mutex and goes to sleep. Later, when woken up, it relocks the mutex and returns a new MutexGuard (which proves that the mutex is locked again).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>collections</span>::<span class=n>VecDeque</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Condvar</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=n>Mutex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>time</span>::<span class=n>Duration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=n>VecDeque</span>::<span class=n>new</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>not_empty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Condvar</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>thread</span>::<span class=n>scope</span><span class=p>(</span><span class=o>|</span><span class=n>s</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>q</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>q</span><span class=p>.</span><span class=n>pop_front</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=w> </span><span class=n>item</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>q</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>not_empty</span><span class=p>.</span><span class=n>wait</span><span class=p>(</span><span class=n>q</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>drop</span><span class=p>(</span><span class=n>q</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>dbg!</span><span class=p>(</span><span class=n>item</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>().</span><span class=n>push_back</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>not_empty</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>thread</span>::<span class=n>sleep</span><span class=p>(</span><span class=n>Duration</span>::<span class=n>from_secs</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Normally, a Condvar is only ever used together with a single Mutex. If two threads try to concurrently wait on a condition variable using two different mutexes, it might cause a panic.</p><h2 id=thread-safety>Thread Safety</h2><blockquote><p>All primitive types such as i32, bool, and str are both Send and Sync.
A struct with fields that are all Send and Sync, is itself also Send and Sync.</p></blockquote><p><strong>Send</strong>
A type is Send if it can be sent to another thread. In other words, if ownership of a value of that type can > be transferred to another thread. For example, <code>Arc&lt;i32></code> is Send, but <code>Rc&lt;i32></code> is not.
<strong>Sync</strong>
A type is Sync if it can be shared with another thread. In other words, a type T is Sync if and only if a > shared reference to that type, &T, is Send. For example, an i32 is Sync, but a <code>Cell&lt;i32></code> is not. (A <code>Cell&lt;i32</code>> is Send, however.)</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>fan-tastic.fun</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2023-04-23
<a href=#ZgotmplZ/commit/d6a180e7020a9aa11f74de009fabf45b12f8d28e title="feat: add Rust Atomics and Locks Low-Level note 1">(d6a180e)</a></span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by/4.0/ target=_blank>çŸ¥è¯†å…±äº«ç½²å4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/rust/>Rust</a></div><nav class=post-nav><a class=next href=/post/thinkphp5_sql_injection/><span class="next-text nav-default">Thinkphp5 SQLæ³¨å…¥æ¼æ´åˆ†æ</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js crossorigin=anonymous></script>
<script type=text/javascript>var gitalk=new Gitalk({id:"2023-04-18 14:38:08 \u002b0800 \u002b0800",title:"ã€ŠRust Atomics and Locks Low-Level ã€‹é˜…è¯»ç¬”è®°1",clientID:"8e56c7d6ce34f788ca8f",clientSecret:"d8012ab38028c2fffa457e0449f958da07dc84e5",repo:"fan-tastic.fun",owner:"peanut-cc",admin:["peanut-cc"],body:decodeURI(location.href)});gitalk.render("gitalk-container")</script><noscript>Please enable JavaScript to view the <a href=https://github.com/gitalk/gitalk>comments powered by gitalk.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=https://github.com/peanut-cc class="iconfont icon-github" title=github></a>
<a href=https://www.fan-tastic.fun/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2022 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>by fan-tastic.fun</span>
<span><a class=theme-link href=https://beian.miit.gov.cn/>è±«ICPå¤‡2022023372å·-1</a></span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script></body></html>